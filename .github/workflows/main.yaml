name: Deploy

on:
  # å½“ä»“åº“è¢« star æˆ– unstar æ—¶è§¦å‘
  watch:
    types: [started]
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© 12:00 UTC å’Œ 00:00 UTCï¼ˆ24ç‚¹ï¼‰
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© 00:00 UTCï¼ˆ24ç‚¹ï¼‰
    - cron: '0 12 * * *'  # æ¯å¤© 12:00 UTCï¼ˆä¸­åˆ12ç‚¹ï¼‰
#   # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
#   push:
#     branches:
#       - main

env:
  # å…è®¸é€šè¿‡ star è§¦å‘æ­¤ workflow çš„ GitHub ç”¨æˆ·ååˆ—è¡¨ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼Œè¯·ä¿®æ”¹ä¸ºå®é™…çš„ç”¨æˆ·åï¼‰
  ALLOWED_USERS: "Xiechengqi"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 1 å°æ—¶
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
    
    steps:
      - name: Check user permission (star trigger)
        if: github.event_name == 'watch'
        run: |
          ALLOWED_USERS="${{ env.ALLOWED_USERS }}"
          SENDER="${{ github.event.sender.login }}"
          
          if [[ " $ALLOWED_USERS " != *" $SENDER "* ]]; then
            echo "âŒ é”™è¯¯: ç”¨æˆ· $SENDER ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­ï¼Œworkflow å·²ç»ˆæ­¢"
            echo "å…è®¸çš„ç”¨æˆ·: $ALLOWED_USERS"
            echo "å½“å‰è§¦å‘ç”¨æˆ·: $SENDER"
            exit 1
          fi
          echo "âœ… ç”¨æˆ· $SENDER star äº†ä»“åº“ï¼Œç»§ç»­æ‰§è¡Œ..."
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Verify Docker is running
        run: docker info
      
      - name: Make run.sh executable
        run: chmod +x run.sh
      
      - name: Run deployment script
        run: ./run.sh

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            git status
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          fi
      
      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "chore: auto-commit changes from workflow [skip ci]"
          git push

name: Deploy

on:
  # 当仓库被 star 或 unstar 时触发
  watch:
    types: [started]
  # 定时触发：每天 12:00 UTC 和 00:00 UTC（24点）
  schedule:
    - cron: '0 0 * * *'   # 每天 00:00 UTC（24点）
    - cron: '0 12 * * *'  # 每天 12:00 UTC（中午12点）
#   # 当推送到 main 分支时触发
#   push:
#     branches:
#       - main

env:
  # 允许通过 star 触发此 workflow 的 GitHub 用户名列表（用空格分隔，请修改为实际的用户名）
  ALLOWED_USERS: "Xiechengqi"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 设置超时时间为 1 小时
    
    steps:
      - name: Check user permission (star trigger)
        if: github.event_name == 'watch'
        run: |
          ALLOWED_USERS="${{ env.ALLOWED_USERS }}"
          SENDER="${{ github.event.sender.login }}"
          
          if [[ " $ALLOWED_USERS " != *" $SENDER "* ]]; then
            echo "❌ 错误: 用户 $SENDER 不在允许列表中，workflow 已终止"
            echo "允许的用户: $ALLOWED_USERS"
            echo "当前触发用户: $SENDER"
            exit 1
          fi
          echo "✅ 用户 $SENDER star 了仓库，继续执行..."
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Verify Docker is running
        run: docker info
      
      - name: Make run.sh executable
        run: chmod +x run.sh
      
      - name: Run deployment script
        run: ./run.sh
